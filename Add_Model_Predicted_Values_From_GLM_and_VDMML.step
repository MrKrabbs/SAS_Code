{"creationTimeStamp":"2023-04-07T17:39:34.652Z","modifiedTimeStamp":"2023-04-07T17:39:34.652Z","createdBy":"sasuser1","modifiedBy":"sasuser1","name":"Add_Model_Predicted_Values_From_GLM_and_VDMML.step","displayName":"Add_Model_Predicted_Values_From_GLM_and_VDMML.step","localDisplayName":"Add_Model_Predicted_Values_From_GLM_and_VDMML.step","properties":{},"links":[{"method":"GET","rel":"self","href":"/dataFlows/steps/2f708666-d09c-487d-942f-3c7f5c9b0771","uri":"/dataFlows/steps/2f708666-d09c-487d-942f-3c7f5c9b0771","type":"application/vnd.sas.data.flow.step"},{"method":"GET","rel":"alternate","href":"/dataFlows/steps/2f708666-d09c-487d-942f-3c7f5c9b0771","uri":"/dataFlows/steps/2f708666-d09c-487d-942f-3c7f5c9b0771","type":"application/vnd.sas.data.flow.step.summary"},{"method":"GET","rel":"up","href":"/dataFlows/steps","uri":"/dataFlows/steps","type":"application/vnd.sas.collection","itemType":"application/vnd.sas.data.flow.step.summary"},{"method":"PUT","rel":"update","href":"/dataFlows/steps/2f708666-d09c-487d-942f-3c7f5c9b0771","uri":"/dataFlows/steps/2f708666-d09c-487d-942f-3c7f5c9b0771","type":"application/vnd.sas.data.flow.step","responseType":"application/vnd.sas.data.flow.step"},{"method":"DELETE","rel":"delete","href":"/dataFlows/steps/2f708666-d09c-487d-942f-3c7f5c9b0771","uri":"/dataFlows/steps/2f708666-d09c-487d-942f-3c7f5c9b0771"},{"method":"GET","rel":"transferExport","href":"/dataFlows/steps/2f708666-d09c-487d-942f-3c7f5c9b0771","uri":"/dataFlows/steps/2f708666-d09c-487d-942f-3c7f5c9b0771","responseType":"application/vnd.sas.transfer.object"},{"method":"PUT","rel":"transferImportUpdate","href":"/dataFlows/steps/2f708666-d09c-487d-942f-3c7f5c9b0771","uri":"/dataFlows/steps/2f708666-d09c-487d-942f-3c7f5c9b0771","type":"application/vnd.sas.transfer.object","responseType":"application/vnd.sas.summary"}],"metadataVersion":0.0,"version":2,"type":"code","flowMetadata":{"inputPorts":[{"name":"inputtable1","displayName":"inputtable1","localDisplayName":"inputtable1","minEntries":1,"maxEntries":1,"type":"table"},{"name":"vdmml_tbl_1","displayName":"vdmml_tbl_1","localDisplayName":"vdmml_tbl_1","minEntries":0,"maxEntries":1,"type":"table"},{"name":"vdmml_tbl_2","displayName":"vdmml_tbl_2","localDisplayName":"vdmml_tbl_2","minEntries":0,"maxEntries":1,"type":"table"},{"name":"vdmml_tbl_3","displayName":"vdmml_tbl_3","localDisplayName":"vdmml_tbl_3","minEntries":0,"maxEntries":1,"type":"table"}],"outputPorts":[]},"ui":"{\n\t\"showPageContentOnly\": true,\n\t\"pages\": [\n\t\t{\n\t\t\t\"id\": \"PageAddPredictedValues\",\n\t\t\t\"type\": \"page\",\n\t\t\t\"label\": \"Add Predicted Values\",\n\t\t\t\"children\": [\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"inputtable1\",\n\t\t\t\t\t\"type\": \"inputtable\",\n\t\t\t\t\t\"label\": \"Select Table Used To Build Model\",\n\t\t\t\t\t\"required\": true,\n\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"sectionVDMML\",\n\t\t\t\t\t\"type\": \"section\",\n\t\t\t\t\t\"label\": \"Option to ADD VDMML Models\",\n\t\t\t\t\t\"open\": true,\n\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\"children\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"text1\",\n\t\t\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\t\t\"text\": \"GLM Models will automatically have their predicted values joined to the table. Below you can select up to three models created in VDMML - Model Studio so that you have have their predicted values joined to the table.\",\n\t\t\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"vdmml_tbl_1\",\n\t\t\t\t\t\t\t\"type\": \"inputtable\",\n\t\t\t\t\t\t\t\"label\": \"Select Table Created in VDMML Using SAS Score Node\",\n\t\t\t\t\t\t\t\"required\": false,\n\t\t\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"vdmml_tbl_2\",\n\t\t\t\t\t\t\t\"type\": \"inputtable\",\n\t\t\t\t\t\t\t\"label\": \"Select Additional Scored Table Created in VDMML\",\n\t\t\t\t\t\t\t\"required\": false,\n\t\t\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"vdmml_tbl_3\",\n\t\t\t\t\t\t\t\"type\": \"inputtable\",\n\t\t\t\t\t\t\t\"label\": \"Select Additional Scored Table Created in VDMML\",\n\t\t\t\t\t\t\t\"required\": false,\n\t\t\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"colselTarget\",\n\t\t\t\t\t\"type\": \"columnselector\",\n\t\t\t\t\t\"label\": \"Select Target\",\n\t\t\t\t\t\"order\": false,\n\t\t\t\t\t\"columntype\": \"a\",\n\t\t\t\t\t\"max\": 1,\n\t\t\t\t\t\"min\": 1,\n\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\"table\": \"inputtable1\"\n\t\t\t\t}\n\t\t\t]\n\t\t}\n\t],\n\t\"syntaxversion\": \"1.3.0\",\n\t\"values\": {\n\t\t\"inputtable1\": {\n\t\t\t\"library\": \"\",\n\t\t\t\"table\": \"\"\n\t\t},\n\t\t\"vdmml_tbl_1\": {\n\t\t\t\"library\": \"PUBLIC\",\n\t\t\t\"table\": \"PICK_A_TABLE\"\n\t\t},\n\t\t\"vdmml_tbl_2\": {\n\t\t\t\"library\": \"PUBLIC\",\n\t\t\t\"table\": \"PICK_A_TABLE\"\n\t\t},\n\t\t\"vdmml_tbl_3\": {\n\t\t\t\"library\": \"PUBLIC\",\n\t\t\t\"table\": \"PICK_A_TABLE\"\n\t\t},\n\t\t\"colselTarget\": []\n\t}\n}","templates":{"SAS":"/* SAS templated code goes here */\n%let myTable=TEMP_MERGE;\n%let myCasLibrary=CASUSER;\n%LET myTarget=&colselTarget_1_name.;\n\n\n/* The macro variables &RUN_MY_SCORING1(2,3,4..) will have a value something like this: score_77434.sas */\nPROC SQL NOPRINT;\nSELECT DISTINCT MY_CODE_FILE,RUNTIME INTO :RUN_MY_SCORING1-, :DO_NOT_USE1- FROM DATAFLDR.AIC_TBL_&SYSUSERID. WHERE MY_CODE_FILE IS NOT NULL\nORDER BY RUNTIME DESC;\nSELECT count(*) INTO :NBR_OF_RUNS FROM DATAFLDR.AIC_TBL_&SYSUSERID. WHERE MY_CODE_FILE IS NOT NULL;\nQUIT;\n\n%let maxRuns = %sysfunc(MIN(&NBR_OF_RUNS, 5));\n\n%MACRO APPLY_GLM_SCORE;\n\nDATA CASUSER.TEMP_GLM_SCORES;\nSET &inputtable1.;\n%DO A = 1 %TO &maxRuns.;\n\tLENGTH \tP_MDL_&A._TYPE $20.;\n\tP_MDL_&A._TYPE = 'GLM';\n%END;\n\nRUN;\n\n/* maxRuns below will be between 1 and 5, ECAUSE THAT IS WHAT THE  VA REPORT IS SETUP FOR IN TERMS OF COMPARING MODELS*/\n%DO I = 1 %TO &maxRuns.;\n\nfilename sfile filesrvc folderpath=\"/Users/&sysuserid./My Folder/OTS_GLM_SCORE_PROGRAMS\" \n\tfilename=\"&&RUN_MY_SCORING&I.\";\n\ndata CASUSER.TEMP_GLM_SCORES;\n\tset CASUSER.TEMP_GLM_SCORES;\n\t%include sfile;\n\tRENAME P_&myTarget. =P_MDL_&I.;\n\tLABEL P_&myTarget. = \"P_MDL_&I.\";\n\n%IF &maxRuns. < 5 %THEN\n%DO;\n\t%IF &I. = &maxRuns. %THEN\n\t%DO J = 1 %TO %EVAL(5 - &maxRuns.);\n\t\t\t%LET M = %eval(&I. + &J.);\n\t\t\tLENGTH \tP_MDL_&M._TYPE $20.;\n\t\t\tP_MDL_&M._TYPE='No Model';\n\t\t\tP_MDL_&M=1;\t\n\t%END;\n%END;\nrun;\n\nfilename sfile CLEAR;\n\nproc sql noprint;\n\tupdate DATAFLDR.AIC_TBL_&SYSUSERID. \n\tset MDL_NBR=&I. ,MODEL_NAME=\"GLM_&I.\"\n\twhere MY_CODE_FILE=\"&&RUN_MY_SCORING&I.\" ;\nquit;\n\n%END;\n\n%MEND APPLY_GLM_SCORE;\n\n%APPLY_GLM_SCORE ;\n\n%MACRO APPLY_VDMML_SCORE(VDMMLTBL,MDLNBR);\n/**********************  NOW LETS BRING IN MODELS FROM VDMML IF WE HAVE ANY         *********************************************/\n/* BELOW IS A VDMML TABLE YOU CREATED WITH THE SCORING NODE */\nPROC CONTENTS DATA=&VDMMLTBL. OUT=PRED_INFO(KEEP=NAME) NOPRINT;RUN;\n\n/* the Value of the macro &RANDOM_PRED_NAME will be something like: IntGrpLR_PUREPREMIUM  and IntGrpLR is the Model Name you provided in VDMML (Model Studio) */\nPROC SQL NOPRINT;\nSELECT DISTINCT NAME INTO :RANDOM_PRED_NAME FROM WORK.PRED_INFO WHERE UPCASE(NAME) NOT IN ('UNIQUERECORDID');\nSELECT SCAN(NAME,1,'_') INTO:MODEL_TYPE FROM WORK.PRED_INFO WHERE UPCASE(NAME) NOT IN ('UNIQUERECORDID');\nQUIT;\n\n\nDATA CASUSER.TEMP_VDMML_SCORES;\nSET &VDMMLTBL.;\nLENGTH \tP_MDL_&MDLNBR._TYPE $20.;\nP_MDL_&MDLNBR._TYPE=\"&MODEL_TYPE.\";\nLABEL &RANDOM_PRED_NAME.='';\nRENAME &RANDOM_PRED_NAME.=P_MDL_&MDLNBR.;\nRUN;\n\n%IF &MDLNBR=6 %THEN\n%DO;\ndata CASUSER.TEMP_MERGE;\n\tmerge CASUSER.TEMP_GLM_SCORES CASUSER.TEMP_VDMML_SCORES;\n\tby uniqueRecordID;\nrun;\n%END;\n%ELSE\n%DO;\ndata CASUSER.TEMP_MERGE;\n\tmerge CASUSER.TEMP_MERGE CASUSER.TEMP_VDMML_SCORES;\n\tby uniqueRecordID;\nrun;\n%END;\n\nproc casutil;\n\tdroptable incaslib=\"CASUSER\" casdata=\"TEMP_VDMML_SCORES\" quiet;\nrun;QUIT;\n\n%MEND APPLY_VDMML_SCORE;\n\n/* ADDING TABLES FROM VDMML IS OPTIONAL, BELOW CHECKS TO SEE IF THEY ADDED AND TAKES TWO DIFFERENT COURSE OF ACTION BASED ON */\n/* WHETHER THEY ADDED A VDMML TABLE AND IF YES, HOW MANY UP TO 3 */\n\n%if %symexist(vdmml_tbl_1) %then \n%do;\n%APPLY_VDMML_SCORE(&vdmml_tbl_1.,6);\n%end;\n%else\n%do;\ndata CASUSER.TEMP_MERGE;\n\tSET CASUSER.TEMP_GLM_SCORES;\n\tLENGTH \tP_MDL_6_TYPE $20.;\n\tP_MDL_6_TYPE='No Model';\n\tP_MDL_6=1;\nRUN;\n%end;\n\n%if %symexist(vdmml_tbl_2) %then \n%do;\n%APPLY_VDMML_SCORE(&vdmml_tbl_2.,7);\n%end;\n%else\n%do;\ndata CASUSER.TEMP_MERGE;\n\tSET CASUSER.TEMP_MERGE;\n\tLENGTH \tP_MDL_7_TYPE $20.;\n\tP_MDL_7_TYPE='No Model';\n\tP_MDL_7=1;\nRUN;\n%end;\n\n%if %symexist(vdmml_tbl_3) %then \n%do;\n%APPLY_VDMML_SCORE(&vdmml_tbl_3.,8);\n%end;\n%else\n%do;\ndata CASUSER.TEMP_MERGE;\n\tSET CASUSER.TEMP_MERGE;\n\tLENGTH \tP_MDL_8_TYPE $20.;\n\tP_MDL_8_TYPE='No Model';\n\tP_MDL_8=1;\nRUN;\n%end;\n\n/* below we strip off the labels as VA uses the labels as the variable names and that can make it difficult to find */\n/* variables that they want to add to a model in VA as VA shows the label and not variable name. By removing label, VA will use variable name */\nproc cas;\n/* \tsession casauto; */\n\n\t/* below will do two things, print out the formats before changing and creating a temp table r that holds info on the columns(variables) */\n\ttable.columninfo result=r / table={caslib=\"&myCasLibrary.\", name=\"&myTable.\"};\n\trun;\n\n\t/* print to the results window column info, specifically formats if they exist */\n\tprint r;\n\trun;\n\n\t/* the object cols below is an array */\n\tcols={};\n\n\tdo row over r.ColumnInfo;\n\t\tcols=cols + {{name=row.Column, label=\"\"}};\n\tend;\n\n\t/* below will print out our array called cols, IMPORTANT, the array will be printed to the log and NOT the results window */\n\t/* this array will simply have the column name and format=missing\\blank\\empty */\n\tprint cols;\n\trun;\n\n\t/* below will alter our table by setting all formats to missing (empty) by leveraging the array called cols */\n\ttable.altertable / caslib=\"&myCasLibrary.\", columns=cols, name=\"&myTable.\";\n\ttable.columninfo result=t / table={caslib=\"&myCasLibrary.\", name=\"&myTable.\"};\n\trun;\n\tprint t;\n\trun;\n\n\nquit;\n\n\nproc casutil;\n\tdroptable incaslib=\"CASUSER\" casdata=\"VISUALIZE_MODELS\" quiet;\nrun;QUIT;\n\nDATA CASUSER.VISUALIZE_MODELS(PROMOTE=YES);\n\tSET CASUSER.TEMP_MERGE;\n\nRUN;\n\nproc casutil;\n\tdroptable incaslib=\"CASUSER\" casdata=\"MODEL_INFO\" quiet;\nrun;QUIT;\n\nDATA CASUSER.MODEL_INFO(PROMOTE=YES);\n\tSET DATAFLDR.AIC_TBL_&SYSUSERID.\n;\n\nIF  ITERATION_NAME = 'VARIABLES FROM ALL ITERATIONS' THEN MDL_NBR = 0;\n\nRUN;\n\nproc casutil;\n\tdroptable incaslib=\"CASUSER\" casdata=\"TEMP_MERGE\" quiet;\nrun;QUIT;"}}